<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-tw" lang="zh-tw">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>{main_webname} 後端管理系統</title>
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE9" />
<!--default -->
<link rel="stylesheet" type="text/css" href="stylesheets/login.css" />
<!--jQuery core-->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"
  integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
  crossorigin="anonymous"></script>
<script type="text/javascript" src="js/jquery/jquery.validate.min.js"></script>
<script type="text/javascript" src="js/jquery/jquery.validate.addMethod.js"></script>
<script type="text/javascript" src="js/bootstrap/js/bootstrap.min.js"></script>
<link rel="stylesheet" type="text/css" href="js/bootstrap/css/bootstrap-tooltip.css">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.20.0/axios.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {

	$("#login01").validate({
		showErrors: function(errorMap, errorList) {
		  $.each(this.validElements(), function (index, element) {
		    var $element = $(element);
		    $element.data("title", "").removeClass("error").tooltip("destroy");
		  });
		  $.each(errorList, function (index, error) {
		    var $element = $(error.element);
		    $element.tooltip("destroy").data("title", error.message).addClass("error").tooltip();
		  });
		},
		rules: {
			pSecret: {
				required: true,
				rangelength: [16,16]
			},
			pCode: {
				required: true,
				rangelength: [6,6],
				number: true,
				digits: true
			},
		},
		messages: {
			pSecret: {
				required:"請填寫16位英數字金鑰",
				rangelength:"最長16半形字"
			},
			pCode: {
				required:"請填寫6位數字驗證碼",
				rangelength:"最長6半形字",
				number:"只能輸入數字",
				digits:"只能輸入整數"
			},
		},
		submitHandler: function(form) {
        	form.submit();
		}
    });

    var verifyCount = 0;
	$("#doPost").click(function() {
	    $("#doPost").attr("disabled", true);
	    $("#doPost").attr("value", "驗證中...");
	    verifyCount++;
	    $("#verifyCount").html(verifyCount);
	    var onecode = document.getElementById("pCode");
	    var onecodeValue = onecode.value;
	    var verifyUrl = "https://www.dahhsin.com.tw/manager/02verifyCodeCheck.php?onecode="+onecodeValue+"&count="+verifyCount+"&id={mbr_id}";
	    axios.get(verifyUrl).then((res) => {
                                console.log(res);
                                if(res.data === 1){
                                    $("#verifyResultOK").show();
                                    var successTime = new Date().getTime();
                                    var x = setInterval(function(){
                                        var now = new Date().getTime();
                                        var countDownTimes = successTime + 2000;
                                        var distance = countDownTimes - now;
                                        var countDownSecs = Math.ceil(distance / 1000);
                                        $("#doPost").attr("value", "登入倒數("+countDownSecs.toString()+")");
                                        //倒數小於0要清掉
                                        if(countDownSecs < 0){
                                            clearInterval(x);
                                            $("#verifyResultOK").hide();
                                        }
                                    } ,1000);
                                    setTimeout(function(){
                                        $("#login01").submit();
                                    }, 2000);
                                }else{
                                    $("#verifyResultFAIL").show();
                                    if(verifyCount < 5){
                                        var errorTime = new Date().getTime();
                                        var x = setInterval(function(){
                                            var now = new Date().getTime();
                                            var countDownTimes = errorTime + 2000;
                                            var distance = countDownTimes - now;
                                            var countDownSecs = Math.ceil(distance / 1000);
                                            $("#doPost").attr("value", "重新驗證倒數("+countDownSecs.toString()+")");
                                            //倒數小於0要清掉
                                            if(countDownSecs < 0){
                                                clearInterval(x);
                                                $("#verifyResultFAIL").hide();
                                                $("#doPost").attr("value", "確定送出");
                                            }
                                        } ,1000);
                                        setTimeout(function(){
                                            $("#doPost").attr("disabled", false);
                                        }, 3000);
                                    }else if(verifyCount == 5){
                                        $("#verifyCount").html(verifyCount+"，已經達到上限");
                                        $("#doPost").attr("value", "鎖定帳密");
                                        $("#doPost").attr("disabled", false);
                                    }else{
                                        $("#verifyCount").html("錯誤次數超過五次，帳號封鎖");
                                        $("#doPost").hide();
                                        $("#back").show();
                                    }
                                }
                            })
                            .catch((error) => {
                                console.log(error);
                                alert("傳輸資料失敗");
                            });
	});
    
    $("#back").on("click", function(){
        window.location = "01login.php";
    });
    
    var sendCount = {sendCount};
    $("#getCode").on("click", function(){
        sendCount++;//計數
        //AJAX呼叫送信
        var requestUrl = "https://www.dahhsin.com.tw/manager/02sendVerifyCodeEmail.php?email={mbr_email}&id={mbr_id}&count="+sendCount.toString();
        axios.get(requestUrl).then((res) => {
                                console.log(res);
                                //alert("已寄信次數"+sendCount.toString()+"\n請去信箱收信");
                            })
                            .catch((error) => {
                                console.log(res);
                                alert("送信失敗");
                            });
        $("#getCode").attr("disabled", true);
        if(sendCount < 6){
            var clickTime = new Date().getTime();
            var x = setInterval(function(){
                var sixSecs = clickTime + 30000;
                var currentTime = new Date().getTime();
                var timeSlip = sixSecs - currentTime;
                var countDown = Math.ceil(timeSlip / 1000);
                $("#time").html("("+countDown+")");
                if(countDown < 0){
                    clearInterval(x);
                    $("#time").html("");
                }
            }, 1000);
            setTimeout(function(){
                $("#getCode").attr("disabled", false);
            }, 30000);
            $("#sendCount").html(sendCount);
        }else{
            $("#sendCount").html("寄信次數已達上限五次，帳號封鎖");
            $("#doPost").hide();
            $("#back").show();
        }
    });
});
</script>
<style>
    #doPost:hover, #reSend:hover, #getCode:hover{
        cursor: pointer;
        background: black;
        color: white;
    }
    #getCode{
        font-size: 1.5rem;
    }
    #back{
        display: none;
        cursor: pointer;
    }
    #pCode{
        font-size: 16px;
    }
    #verifyResultOK, #verifyResultFAIL{
        font-size: 1.5rem;
        display: none;
        background-color: none;
        font-weight: bold;
        border: none;
        color: darkred;
    }
</style>
</head>
<body>

  <form name="login01" id="login01" action="03login_action.php" method="post" >

 	<div class="login_title01">
            <ul class="title01">
                <li><img src="images/image1.jpg" width="430" height="198" alt="" /></li>
            </ul>
            <ul class="title02">
                <li>{main_webname} 後端管理系統</li>
            </ul>
	</div>

	<div class="login_table01">
            <ul class="title01">
                <li><font color="red">請先點擊「獲取驗證碼」再到信箱收信</font>。沒收到信請去檢查垃圾桶。最多只能寄五次</li>
                <li>驗證碼打錯五次也會鎖帳號！杜絕一切不正當後台登入</li>
                <input name="pUserUnit" type="hidden" value="{mbr_unit}">
            </ul>
            <ul class="input01">
                <li class="text01">帳&nbsp;&nbsp;號：</li>
                <li><label>{mbr_id}</label>
                    <input name="pUserID" value="{mbr_id}" type="hidden">
                </li>
            </ul>
            <ul class="input01">
                <li class="text01">驗證碼：</li>
                <li><input name="pCode" type="text" size="16" maxlength="6" id="pCode">&emsp;<button type="button" id="getCode">獲取驗證碼<span id="time"></span></button></li>
            </ul>
            <ul class="button01">
                <li><button type="button" id="verifyResultOK">驗證成功</button></li>
                <li><button type="button" id="verifyResultFAIL">驗證失敗</button></li>
            </ul>
            <ul class="input01">
                <li class="text01">寄信次數：</li>
                <li><label id="sendCount">{sendCount}</label></li>
            </ul>
            <ul class="input01">
                <li class="text01">驗證次數：</li>
                <li><label id="verifyCount">0</label></li>
            </ul>
            <ul class="button01">
                <li><input type="button" name="doPost" id="doPost" value="確定送出"></li>
                <li><input type="button" name="back" id="back" value="回上一頁"></li>
            </ul>
            
	</div>


  </form>

</body>
</html>